(function(c){var d={entryPoint:null,searchEntryPoint:null,portal:null,space:null,node:null,language:null,session:null,timeout:10,cache:true};var b=true;c.eSengoCity={setOptions:function(e){d=c.extend({},d,e)},setConnectivity:function(e){b=(e==true)},listSpaces:function(e){var f={fullFetch:true,requireNode:true};e=(e===undefined)?c.extend({},f,d):c.extend({},d,f,e);return new a("listSpaces",e)},listCategories:function(e){var f={fullFetch:true,requireNode:true,requireSpace:true};e=(e===undefined)?c.extend({},f,d):c.extend({},d,f,e);return new a("listCategories",e)},listPromotions:function(e){var f={requireNode:true,requireSpace:true};e=(e===undefined)?c.extend({},f,d):c.extend({},d,f,e);return new a("listPromotions",e)},customStore:function(f,e){e=(e===undefined)?c.extend({},d):c.extend({},d,e);return new a(f,e)},search:function(f,e){return this.searchCustom("all",f,e)},searchProducts:function(f,e){return this.searchCustom("product",f,e)},searchPromotions:function(f,e){return this.searchCustom("promotion",f,e)},searchEntities:function(f,e){return this.searchCustom("entity",f,e)},searchGTIN:function(f,e){return this.searchCustom("gtin",f,e)},searchCustom:function(g,h,e){if(g===undefined||g===null||g==""){g="all"}if(h===undefined||h===null||h==""){h="*"}var f={requirePortal:true,requireSpace:true,query:h};e=(e===undefined)?c.extend({},f,d):c.extend({},d,f,e);return new a(g,e)}};function a(g,f){var q=this;var p={pageSize:8,fetchPages:5,cacheTimeout:20,useOldOnError:true,fullFetch:false,prefetch:true,category:null,subcategory:null,orderBy:null,properties:[],query:null,requireNode:false,requirePortal:false,requireLanguage:false,requireSpace:false,onReset:null};var t=0;var m=0;var w=0;var i=true;var n=0;var k=[];var e=0;var j=null;var h=null;var s=null;var l=null;this.setOptions=function(o){var y=c.extend({},p,o);if(p.pageSize<1){p.pageSize=1}var z=false;if(y.pageSize!=p.pageSize){m=Math.ceil(t/y.pageSize);z=true}if(!(y.properties instanceof Array)){y.properties=[y.properties]}y.properties.sort();if(y.properties.length!=p.properties.length){z=true}else{for(var x=0;x<y.properties.length;x++){if(y.properties[x]!=p.properties[x]){z=true;break}}}if(y.entryPoint!=p.entryPoint){z=true}if(y.portal!=p.portal){z=true}if(y.space!=p.space){z=true}if(y.language!=p.language){z=true}if(y.orderBy!=p.orderBy){z=true}if(y.fullFetch!=p.fullFetch){z=true}if(y.session!=p.session){z=true}if(y.query!=p.query){z=true}if(z){i=true;n=0;k=[];if(j){j=null;h.reject("cancel","The request was canceled by a newer request.")}if(c.isFunction(y.onReset)){y.onReset()}}p=y};this.setLocation=function(x,o){if(typeof(encodeGeoHash)=="function"){l=encodeGeoHash(x,o)}};this.getPage=function(y,x){var o=c.Deferred();y=(y===undefined)?0:+y;x=(x===undefined)?1:+x;if(this.isPageLoaded(y,x)){r(o,y,x);if(p.prefetch&&j===null){if(((y+x)<m)&&!q.isPageLoaded(y+x)&&(y+x)<m){var z=c.Deferred();v(z,y+x,1)}else{if((y>0)&&!q.isPageLoaded(y-1)){var z=c.Deferred();v(z,y-1,1)}}}}else{v(o,y,x)}return o};this.getItemsCount=function(){return t};this.getHitsCount=function(){return w};this.getPagesCount=function(){return m};this.getPageSize=function(){return p.pageSize};this.setPageSize=function(o){this.setOptions({pageSize:o})};this.getLoadedItemsCount=function(){return(k.length>0)?(k.length-1)*p.pageSize+k[k.length-1].items.length:0};this.getLoadedPagesCount=function(){return k.length};this.clear=function(){i=true;n=0;k=[];if(j){j=null;h.reject("cancel","The request was canceled by a newer request.")}if(c.isFunction(p.onReset)){p.onReset()}};this.isPageLoaded=function(o,y,A){o=(o===undefined||o===null)?0:+o;y=(y===undefined||y===null)?1:+y;A=(A===undefined)?false:A;if(y<1){y=1}if(o>=n){o-=n;if((o+y)<=k.length){var x=true;if(!A){var B=+new Date;for(var z=0;z<y;z++){if(B>(k[o+z].created+p.cacheTimeout*60000)){x=false;break}}}return x}}return false};this.setOptions(f);function u(o,D){if(D.length==0){return}var x=Math.ceil(D.length/p.pageSize);var C=[];var A=n;if(n<o&&(n+k.length)>=o){for(var B=n;B<o;B++){C.push(k[B-n])}}else{n=o}var z=0;for(var B=0;B<x;B++){var E={items:[],created:+new Date};for(var y=0;y<p.pageSize;y++){if(z>=D.length){break}E.items.push(D[z++])}C.push(E)}if(A<=(o+x)&&(A+k.length)>(o+x)){var B=(o+x)-A;while(B<k.length){C.push(k[B++])}}k=C}function r(o,A,x,C,B){C=(C===undefined)?false:C;if((i||A<m)&&(((!C||!p.useOldOnError)&&!q.isPageLoaded(A))||(C&&p.useOldOnError&&!q.isPageLoaded(A,1,true)))){o.reject("error",(B===undefined)?"Could not fetch the wanted data.":B);return}var y={firstPage:A,pageCount:m,pageSize:p.pageSize,itemCount:t,pages:[]};if(k.length){A-=n;for(var z=0;z<x;z++){if((C&&p.useOldOnError&&!q.isPageLoaded(z+A+n,1,true))||((!C||!p.useOldOnError)&&!q.isPageLoaded(z+A+n))){break}y.pages.push(k[A+z])}}o.resolve(y)}function v(F,A,G){if((g===undefined||g===null||g=="")||(p.query===null&&p.entryPoint===null)||(p.query!==null&&p.searchEntryPoint===null)||(p.requireNode&&p.node===null)||(p.requirePortal&&p.portal===null)||(p.requireSpace&&p.space===null)||(p.requireLanguage&&p.language===null)){F.reject("error","One or more required arguments are missing.");return}A=(A===undefined||A===null)?0:+A;G=(G===undefined||G===null)?1:+G;var E=p.fullFetch;var D=p.pageSize;if(!b){r(F,A,G,true);return}var o;var C="?";if(p.query===null){o=p.entryPoint+encodeURIComponent(g);if(p.node!==null){o+=C+"node="+encodeURIComponent(p.node);C="&"}if(p.language!==null){o+=C+"lang="+encodeURIComponent(p.language);C="&"}if(p.portal!==null){o+=C+"portal="+encodeURIComponent(p.portal);C="&"}if(p.space!==null){o+=C+"space="+encodeURIComponent(p.space);C="&"}if(p.properties.length>0){o+=C+"props=";C="&";if(p.properties.indexOf("DEFAULTS")<0){p.properties.unshift("DEFAULTS")}for(var y=0;y<p.properties.length;y++){if(y>0){o+=","}o+=encodeURIComponent(p.properties[y])}}}else{o=p.searchEntryPoint+encodeURIComponent(p.portal)+"/"+encodeURIComponent(p.space)+"/";if(g=="gtin"){o+="gtin/"}else{if(g!="all"){o+=encodeURIComponent(g)+"/";if(p.category!==null){o+=encodeURIComponent(p.category)+"/";if(p.subcategory!==null){o+=encodeURIComponent(p.subcategory)+"/"}}}}o+=encodeURIComponent(p.query)}if(!E){var z=A;var B=G;if(i||(k.length==0&&m>0)){if((z+B)<=p.fetchPages){z=0;B=p.fetchPages}}if(p.prefetch){if((z>0)&&!q.isPageLoaded(z-1)){z--;B++}if(((z+B)<m)&&!q.isPageLoaded(z+B)){B++}}o+=C+"start="+z*D;C="&";o+=C+"max="+B*D}var x=e++;if(j!==null){h.reject("cancel","The request was canceled by a newer request.")}h=F;j=x;c.ajax({url:o,cache:p.cache,timeout:p.timeout*1000,dataType:"json",beforeSend:function(I){I.setRequestHeader("Accept","application/json,text/json;q=0.9,text/plain;q=0.8,*/*;q=0.5");var H;if(p.language!==null){if(p.language=="en"){H="en,*;q=0.5"}else{H=p.language+",en;q=0.8,*;q=0.5"}}else{H="en,*;q=0.5"}I.setRequestHeader("Accept-Language",H);if(p.session!==null){I.setRequestHeader("X-Isencia-Session",p.session)}if(s!==null){I.setRequestHeader("X-Isencia-Store",s)}if(l!==null){I.setRequestHeader("X-Isencia-Geo",l)}}}).done(function(L,N,J){var H,I,M;if("elements" in L){H=L.elements}else{H=[]}if("size" in L){I=+L.size}else{I=H.length}if("hits" in L){hits=+L.hits}else{hits=I}var M=Math.ceil(H.length/D);if(j===x){j=null;var K=J.getResponseHeader("X-Isencia-Store");if(K!==undefined&&K!==null){if(s===null){s=K}else{if(s!=K){n=0;k=[];s=K;if(c.isFunction(p.onReset)){p.onReset()}}}}i=false;w=hits;if(E&&I==H.length){n=0;if(I>0){k=[{items:H,created:+new Date}];m=1;t=H.length;p.pageSize=t}else{k=[];m=0;t=0}r(F,0,1)}else{if(I!=t){n=0;k=[];if(c.isFunction(p.onReset)){p.onReset()}}t=I;m=Math.ceil(t/p.pageSize);u(z,H);r(F,A,G)}}else{if(!E&&!p.fullFetch&&I==t){u(z,H)}}}).fail(function(H,K,I){if(j!==x){return}var J="Unknown fetch error.";if(H.status){switch(H.status){case 400:J="Server understood the request but request content was invalid.";break;case 401:J="Unauthorized access.";break;case 403:J="Forbidden resource can't be accessed.";break;case 404:J="The requested resource does not exist.";break;case 500:J="Internal server error.";break;case 503:J="Service unavailable.";break;default:J="Unknown HTTP error ("+H.status+").";break}}else{if(K=="timeout"){J="Request timed out."}else{if(K=="parsererror"){J="Parsing JSON Request failed."}else{if(K=="abort"){J="Request was aborted by the server."}}}}r(F,A,G,true,J)})}}})(jQuery);