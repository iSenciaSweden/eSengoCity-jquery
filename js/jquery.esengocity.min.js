/* Copyright (c) 2013-2014 iSencia AB (http://www.isencia.se/)
 * Licensed under the MIT (LICENSE)
 *
 * Version: 0.4.0
 * Requires jQuery 1.3+
 * Optional geohash-js
 * Docs: https://github.com/iSenciaSweden/eSengoCity-jquery
 */
(function(c){var d={entryPoint:null,searchEntryPoint:null,portal:null,space:null,node:null,language:null,session:null,timeout:10,cache:true};var b=true;c.eSengoCity={setOptions:function(e){d=c.extend({},d,e)},setConnectivity:function(e){b=(e==true)},listSpaces:function(e){var f={fullFetch:true,requireNode:true};e=(e===undefined)?c.extend({},f,d):c.extend({},d,f,e);return new a("listSpaces",e)},listCategories:function(e){var f={fullFetch:true,requireNode:true,requireSpace:true};e=(e===undefined)?c.extend({},f,d):c.extend({},d,f,e);return new a("listCategories",e)},listPromotions:function(e){var f={requireNode:true,requireSpace:true};e=(e===undefined)?c.extend({},f,d):c.extend({},d,f,e);return new a("listPromotions",e)},customStore:function(f,e){e=(e===undefined)?c.extend({},d):c.extend({},d,e);return new a(f,e)},search:function(f,e){return this.searchCustom("all",f,e)},searchProducts:function(f,e){return this.searchCustom("product",f,e)},searchPromotions:function(f,e){return this.searchCustom("promotion",f,e)},searchEntities:function(f,e){return this.searchCustom("entity",f,e)},searchGTIN:function(f,e){return this.searchCustom("gtin",f,e)},searchCustom:function(g,h,e){if(g===undefined||g===null||g==""){g="all"}if(h===undefined||h===null||h==""){h="*"}var f={requirePortal:true,requireSpace:true,query:h};e=(e===undefined)?c.extend({},f,d):c.extend({},d,f,e);return new a(g,e)}};function a(h,g){var s=this;var r={pageSize:8,fetchPages:5,cacheTimeout:20,useOldOnError:true,fullFetch:false,prefetch:true,category:null,subcategory:null,orderBy:null,properties:[],query:null,requireNode:false,requirePortal:false,requireLanguage:false,requireSpace:false,onReset:null};var v=0;var p=0;var y=0;var k=true;var q=0;var m=[];var f=0;var l=null;var j=null;var u=null;var i=null;var n=null;var e=null;this.setOptions=function(o){var A=c.extend({},r,o);if(r.pageSize<1){r.pageSize=1}var B=false;if(A.pageSize!=r.pageSize){p=Math.ceil(v/A.pageSize);B=true}if(!(A.properties instanceof Array)){A.properties=[A.properties]}A.properties.sort();if(A.properties.length!=r.properties.length){B=true}else{for(var z=0;z<A.properties.length;z++){if(A.properties[z]!=r.properties[z]){B=true;break}}}if(A.entryPoint!=r.entryPoint){B=true}if(A.portal!=r.portal){B=true}if(A.space!=r.space){B=true}if(A.language!=r.language){B=true}if(A.orderBy!=r.orderBy){B=true}if(A.fullFetch!=r.fullFetch){B=true}if(A.session!=r.session){B=true}if(A.query!=r.query){B=true}if(B){k=true;q=0;m=[];if(l){l=null;j.reject("cancel","The request was canceled by a newer request.")}i=null;if(c.isFunction(A.onReset)){A.onReset()}}r=A};this.setLocation=function(z,o){if(typeof(encodeGeoHash)=="function"){n=encodeGeoHash(z,o)}};this.getPage=function(A,z){var o=c.Deferred();A=(A===undefined)?0:+A;z=(z===undefined)?1:+z;if(this.isPageLoaded(A,z)){t(o,A,z);if(r.prefetch&&l===null){if(((A+z)<p)&&!s.isPageLoaded(A+z)&&(A+z)<p){var B=c.Deferred();x(B,A+z,1)}else{if((A>0)&&!s.isPageLoaded(A-1)){var B=c.Deferred();x(B,A-1,1)}}}}else{x(o,A,z)}return o};this.getStoreId=function(){if(u!==null){return u}if(i===null){i="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(A){var z=Math.random()*16|0,o=A=="x"?z:z&3|8;return o.toString(16)})}return i};this.getSpelling=function(){return e};this.getItemsCount=function(){return v};this.getHitsCount=function(){return y};this.getPagesCount=function(){return p};this.getPageSize=function(){return r.pageSize};this.setPageSize=function(o){this.setOptions({pageSize:o})};this.getLoadedItemsCount=function(){return(m.length>0)?(m.length-1)*r.pageSize+m[m.length-1].items.length:0};this.getLoadedPagesCount=function(){return m.length};this.clear=function(){k=true;q=0;m=[];if(l){l=null;j.reject("cancel","The request was canceled by a newer request.")}i=null;if(c.isFunction(r.onReset)){r.onReset()}};this.isPageLoaded=function(o,A,C){o=(o===undefined||o===null)?0:+o;A=(A===undefined||A===null)?1:+A;C=(C===undefined)?false:C;if(A<1){A=1}if(o>=q){o-=q;if((o+A)<=m.length){var z=true;if(!C){var D=+new Date;for(var B=0;B<A;B++){if(D>(m[o+B].created+r.cacheTimeout*60000)){z=false;break}}}return z}}return false};this.setOptions(g);function w(o,F){if(F.length==0){return}var z=Math.ceil(F.length/r.pageSize);var E=[];var C=q;if(q<o&&(q+m.length)>=o){for(var D=q;D<o;D++){E.push(m[D-q])}}else{q=o}var B=0;for(var D=0;D<z;D++){var G={items:[],created:+new Date};for(var A=0;A<r.pageSize;A++){if(B>=F.length){break}G.items.push(F[B++])}E.push(G)}if(C<=(o+z)&&(C+m.length)>(o+z)){var D=(o+z)-C;while(D<m.length){E.push(m[D++])}}m=E}function t(o,C,z,E,D){E=(E===undefined)?false:E;if((k||C<p)&&(((!E||!r.useOldOnError)&&!s.isPageLoaded(C))||(E&&r.useOldOnError&&!s.isPageLoaded(C,1,true)))){o.reject("error",(D===undefined)?"Could not fetch the wanted data.":D);return}var A={firstPage:C,pageCount:p,pageSize:r.pageSize,itemCount:v,pages:[]};if(m.length){C-=q;for(var B=0;B<z;B++){if((E&&r.useOldOnError&&!s.isPageLoaded(B+C+q,1,true))||((!E||!r.useOldOnError)&&!s.isPageLoaded(B+C+q))){break}A.pages.push(m[C+B])}}o.resolve(A)}function x(H,C,I){if((h===undefined||h===null||h=="")||(r.query===null&&r.entryPoint===null)||(r.query!==null&&r.searchEntryPoint===null)||(r.requireNode&&r.node===null)||(r.requirePortal&&r.portal===null)||(r.requireSpace&&r.space===null)||(r.requireLanguage&&r.language===null)){H.reject("error","One or more required arguments are missing.");return}C=(C===undefined||C===null)?0:+C;I=(I===undefined||I===null)?1:+I;var G=r.fullFetch;var F=r.pageSize;if(!b){t(H,C,I,true);return}var o;var E="?";if(r.query===null){o=r.entryPoint+encodeURIComponent(h);if(r.node!==null){o+=E+"node="+encodeURIComponent(r.node);E="&"}if(r.language!==null){o+=E+"lang="+encodeURIComponent(r.language);E="&"}if(r.portal!==null){o+=E+"portal="+encodeURIComponent(r.portal);E="&"}if(r.space!==null){o+=E+"space="+encodeURIComponent(r.space);E="&"}if(r.properties.length>0){o+=E+"props=";E="&";if(r.properties.indexOf("DEFAULTS")<0){r.properties.unshift("DEFAULTS")}for(var A=0;A<r.properties.length;A++){if(A>0){o+=","}o+=encodeURIComponent(r.properties[A])}}}else{o=r.searchEntryPoint+encodeURIComponent(r.portal)+"/"+encodeURIComponent(r.space)+"/";if(h=="gtin"){o+="gtin/"}else{if(h!="all"){o+=encodeURIComponent(h)+"/";if(r.category!==null){o+=encodeURIComponent(r.category)+"/";if(r.subcategory!==null){o+=encodeURIComponent(r.subcategory)+"/"}}}}o+=encodeURIComponent(r.query)}if(!G){var B=C;var D=I;if(k||(m.length==0&&p>0)){if((B+D)<=r.fetchPages){B=0;D=r.fetchPages}}if(r.prefetch){if((B>0)&&!s.isPageLoaded(B-1)){B--;D++}if(((B+D)<p)&&!s.isPageLoaded(B+D)){D++}}o+=E+"start="+B*F;E="&";o+=E+"max="+D*F}var z=f++;if(l!==null){j.reject("cancel","The request was canceled by a newer request.")}j=H;l=z;c.ajax({url:o,cache:r.cache,timeout:r.timeout*1000,dataType:"json",beforeSend:function(K){K.setRequestHeader("Accept","application/json,text/json;q=0.9,text/plain;q=0.8,*/*;q=0.5");var J;if(r.language!==null){if(r.language=="en"){J="en,*;q=0.5"}else{J=r.language+",en;q=0.8,*;q=0.5"}}else{J="en,*;q=0.5"}K.setRequestHeader("Accept-Language",J);if(r.session!==null){K.setRequestHeader("X-Isencia-Session",r.session)}if(u!==null){K.setRequestHeader("X-Isencia-Store",u)}if(n!==null){K.setRequestHeader("X-Isencia-Geo",n)}}}).done(function(N,Q,L){var J,K,P;var O=false;if("elements" in N){J=N.elements}else{J=[]}if("size" in N){K=+N.size}else{K=J.length}if("hits" in N){hits=+N.hits}else{hits=K}if("spelling" in N){e=N.spelling}else{e=null}var P=Math.ceil(J.length/F);if(l===z){l=null;var M=L.getResponseHeader("X-Isencia-Store");if(M!==undefined&&M!==null){if(u===null){u=M}else{if(u!=M){q=0;m=[];u=M;O=true}}}y=hits;if(G&&K==J.length){k=false;q=0;if(K>0){m=[{items:J,created:+new Date}];p=1;v=J.length;r.pageSize=v}else{m=[];p=0;v=0}t(H,0,1)}else{if(K!=v&&!k){q=0;m=[];O=true}k=false;v=K;p=Math.ceil(v/r.pageSize);w(B,J);if(O&&c.isFunction(r.onReset)){r.onReset()}i=null;t(H,C,I)}}else{if(!G&&!r.fullFetch&&K==v){w(B,J)}}}).fail(function(J,M,K){if(l!==z){return}var L="Unknown fetch error.";if(J.status){switch(J.status){case 400:L="Server understood the request but request content was invalid.";break;case 401:L="Unauthorized access.";break;case 403:L="Forbidden resource can't be accessed.";break;case 404:L="The requested resource does not exist.";break;case 500:L="Internal server error.";break;case 503:L="Service unavailable.";break;default:L="Unknown HTTP error ("+J.status+").";break}}else{if(M=="timeout"){L="Request timed out."}else{if(M=="parsererror"){L="Parsing JSON Request failed."}else{if(M=="abort"){L="Request was aborted by the server."}}}}t(H,C,I,true,L)})}}})(jQuery);